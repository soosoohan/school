<!DOCTYPE html>
<html lang="ko">
<head>
 <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4YZHC1G9FN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4YZHC1G9FN');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ëª¨ìŒìŠ¤ì¿¨ - ì´ˆë“±í•™ìƒ í•™ìŠµ í€´ì¦ˆ | Soosooland</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ì´ˆë“±í•™êµ êµìœ¡ê³¼ì •ì—ì„œ ë°°ìš°ëŠ” ë‚´ìš©ì„ í€´ì¦ˆë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ì—ë¹™í•˜ìš°ìŠ¤ ë§ê°ê³¡ì„ ì„ ì ìš©í•œ ê³¼í•™ì  ë°˜ë³µ í•™ìŠµìœ¼ë¡œ ê¸°ì–µë ¥ í–¥ìƒ">
    <meta name="keywords" content="ê¸°ì–µë ¥ í–¥ìƒ, ë°˜ë³µ í•™ìŠµ, ì´ˆë“±êµìœ¡ê³¼ì •, ì´ˆë“±êµìœ¡, ëª¨ìŒìŠ¤ì¿¨, ì´ˆë“±í€´ì¦ˆ, ì—ë¹™í•˜ìš°ìŠ¤">
    <meta name="author" content="Soosooland">
    
    <!-- Open Graph -->
    <meta property="og:title" content="ëª¨ìŒìŠ¤ì¿¨ - ì´ˆë“±í•™ìƒ í•™ìŠµ í€´ì¦ˆ">
    <meta property="og:description" content="ì´ˆë“±í•™êµ êµìœ¡ê³¼ì • ê¸°ë°˜ í•™ìŠµ í€´ì¦ˆ. ì—ë¹™í•˜ìš°ìŠ¤ ë§ê°ê³¡ì„ ì„ ì ìš©í•œ ê³¼í•™ì  ë°˜ë³µ í•™ìŠµìœ¼ë¡œ ê¸°ì–µë ¥ í–¥ìƒ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://soosooland.com/school/school.html">
    <link rel="canonical" href="https://soosooland.com/school/school.html">
    <link rel="stylesheet" href="https://soosooland.com/css/protection.css">
    <script src="https://soosooland.com/js/protection.js"></script>
<style>
        :root {
            --bg-color: #145454;
            --white-color: #F4F6F5;
            --black-color: #1B2B2B;
            --primary-color: #6F8FA3;
            --sub-color: #2F4B5C;
            --accent-color: #2F4B5C;
        }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

body {
font-family: 'Malgun Gothic', sans-serif;
background: var(--bg-color);
min-height: 100vh;
padding: 20px;
}

.container {
max-width: 750px;
margin: 0 auto;
}

.header {
text-align: center;
margin-bottom: 30px;
}
.title {
font-size: 1.8em;
font-weight: bold;
color: var(--white-color);
margin-bottom: 10px;
}  
.subtitle {
color: var(--primary-color);
font-size: 1.4em;
font-weight: bold;
margin-bottom: 5px;
}

.game-desc {
color: var(--white-color);
font-size: 1.1em;
}

.game-board {
background: var(--white-color);
border-radius: 12px;
padding: 30px;
margin-bottom: 20px;
}

.round-section {
background: var(--primary-color);
border-radius: 8px;
padding: 10px;
margin-bottom: 15px;
display: flex;
justify-content: space-between;
align-items: center;
color: var(--black-color);
}

.round-display {
font-size: 1.3em;
color: var(--black-color);
font-weight: bold;
}

.score-display {
font-size: 1.3em;
color: var(--black-color);
font-weight: bold;
}

.next-round-btn {
background: var(--sub-color);
color: var(--white-color);
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1.1em;
margin-top: 15px;
transition: all 0.3s ease;
}

.next-round-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.final-message {
text-align: center;
margin-bottom: 20px;
}

.final-alert {
background: var(--white-color);
border: 2px solid var(--primary-color);
color: var(--black-color);
padding: 20px;
border-radius: 8px;
font-size: 1.4em;
font-weight: bold;
}

.retry-wrong-btn {
background: var(--accent-color);
color: var(--white-color);
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1.1em;
transition: all 0.3s ease;
}

.sentence-display {
text-align: center;
margin-bottom: 20px;
}

.sentence-area {
font-size: 3em;
background: var(--white-color);
padding: 15px;
border-radius: 8px;
min-height: 120px;
display: flex;
align-items: center;
justify-content: center;
flex-wrap: wrap;
gap: 10px;
line-height: 1.2;
word-break: keep-all;
overflow-wrap: break-word;
}

.word-group {
display: inline-flex;
flex-wrap: nowrap;
white-space: nowrap;
align-items: center;
margin-right: 0.3em;
color: var(--black-color);
}

.word-group:last-child {
margin-right: 0;
}

.hangul-char {
display: inline-block;
min-width: 1em;
height: 1.2em;
text-align: center;
vertical-align: baseline;
font-family: 'Malgun Gothic', sans-serif;
}

.incomplete-char {
background: var(--white-color);
color: var(--black-color);
display: inline-flex;
align-items: center;
justify-content: center;
min-width: 1em;
height: 1.2em;
}

.complete-char {
color: var(--black-color);
}

.space {
width: 0.5em;
}

.win-message {
text-align: center;
margin-bottom: 20px;
}

.win-alert {
background: var(--white-color);
border: 1px solid var(--primary-color);
color: var(--black-color);
padding: 15px;
border-radius: 8px;
font-size: 1.2em;
}

.lose-message {
text-align: center;
margin-bottom: 20px;
}

.lose-alert {
background: var(--primary-color);
border: 1px solid var(--primary-color);
color: var(--black-color);
padding: 15px;
border-radius: 8px;
font-size: 1.2em;
}

.wrong-attempts {
background: var(--primary-color);
color: var(--black-color);
padding: 8px 12px;
border-radius: 6px;
font-weight: bold;
margin-left: 10px;
}

.hint-section {
  background: var(--sub-color);
  color: var(--white-color);
  padding: 15px;
  margin-bottom: 10px;
  text-align: center;
}

.hint-title {
  font-size: 1.2em;
  color: var(--white-color);
  font-weight: bold;
  margin-bottom: 5px;
  display: inline;
}

.hint-text {
  font-size: 1.3em;
  color: var(--white-color);
  font-weight: bold;
  display: inline;
}

.hint-text .emoji {
  font-size: 2em;
  vertical-align: middle;
}

.consonant-section {
background: var(--white-color);
border-radius: 12px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
padding: 30px;
margin-bottom: 20px;
max-width: 750px;
margin: 0 auto 20px auto;  
}

.consonant-title {
font-size: 1.2em;
font-weight: 600;
margin-bottom: 20px;
text-align: center;
color: var(--black-color);
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
flex-wrap: wrap;
}

.title-text-desktop {
display: inline;
}

.title-text-mobile {
display: none;
}

.consonant-input {
width: 50px;
height: 40px;
font-size: clamp(16px, 1.5em, 24px);
text-align: center;
border: 2px solid var(--primary-color);
border-radius: 8px;
padding: 5px;
font-family: 'Malgun Gothic', sans-serif;
background: white;
color: var(--black-color);
}

.consonant-input:focus {
outline: none;
border-color: var(--sub-color);
box-shadow: 0 0 5px var(--sub-color);
}

.consonant-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 10px;
}

.consonant-btn {
width: 60px;
height: 60px;
font-size: 1.4em;
font-weight: bold;
border-radius: 8px;
border: 2px solid;
cursor: pointer;
transition: all 0.2s;
}

.consonant-btn.available {
background: var(--primary-color);
color:var(--black-color);
}

.consonant-btn.available:hover {
background: linear-gradient(135deg, #7AB2D3, #B9E5E8);
color: white;
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(74, 98, 138, 0.3);
}

.consonant-btn.correct {
background:var(--white-color);
color: var(--black-color);
border-color: #4A628A;
}

.consonant-btn.wrong {
background:var(--white-color);
color: var(--black-color);
border-color: var(--primary-color);
cursor: not-allowed;
}

.game-info {
display: flex;
justify-content: space-between;
align-items: center;
background: var(--bg-color);
padding: 10px;
margin-bottom: 20px;
max-width: 750px;
margin: 0 auto 20px auto;
}

.stats {
font-size: 1.3em;
font-weight: bold;
color: var(--primary-color);
}

.new-game-btn {
background: var(--accent-color);
color: var(--white-color);
padding: 10px 20px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1em;
transition: all 0.3s ease;
}

.new-game-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* ë³µìŠµ ëª¨ë“œ í‘œì‹œ ë°°ë„ˆ */
.review-banner {
background: #FF9800;
color: white;
padding: 10px;
border-radius: 8px;
text-align: center;
font-weight: bold;
font-size: 1.1em;
margin-bottom: 15px;
}

@media (max-width: 600px) {
.title {
font-size: 1.8em;
}
.sentence-area {
font-size: 1.8em;
padding: 20px;
min-height: 80px;
}

.consonant-grid {
    grid-template-columns: repeat(5, 1fr);
}

.consonant-btn {
    width: 100%;
    height: 50px;
    font-size: 1.0em;
}

.new-game-btn {
    width: 100%;
    padding: 12px 0;
    font-size: 1em;
}

.game-info {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
}

.game-info > div {
    width: 100%;
}

.container {
    padding: 10px;
}

.consonant-title {
    font-size: 1em;
    flex-direction: column;
    gap: 5px;
}
.title-text-desktop {
    display: none;
}

.title-text-mobile {
    display: inline;
}

.consonant-input {
    width: 60px;
    height: 45px;
    display: none;
}    
}

</style>

</head>
<body>
<div class="container">
 <div class="header">
    <h1 class="title">ëª¨ìŒ ìŠ¤ì¿¨</h1>
    <p class="subtitle" id="categoryTitle">ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
</div>

  <div class="game-board">
    <!-- ë³µìŠµ ëª¨ë“œì¼ ë•Œ í‘œì‹œë˜ëŠ” ë°°ë„ˆ -->
    <div class="review-banner" id="reviewBanner" style="display: none;">
      ğŸ“ ë³µìŠµ ëª¨ë“œ - 1ì°¨ ê³µë¶€ì—ì„œ í‹€ë¦° ë¬¸ì œë¥¼ ë³µìŠµí•©ë‹ˆë‹¤
    </div>
    
    <div class="round-section">
      <div class="round-display" id="roundDisplay">ë¬¸ì œ 1/10</div>
      <div class="score-display" id="scoreDisplay">ì •ë‹µ: 0/10</div>
    </div>

<div class="hint-section">
  <div class="hint-title">ğŸ’¡ </div>
  <div class="hint-text" id="hintText">ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
</div>
<div class="sentence-display">
  <div class="sentence-area" id="sentenceArea">
    ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!
  </div>
</div>
<div id="winMessage" class="win-message" style="display: none;">
<div class="win-alert">
    ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰
</div>
<button class="next-round-btn" onclick="nextRound()">ë‹¤ìŒ ë¬¸ì œ â†’</button>

</div>
  </div>
  <div id="loseMessage" class="lose-message" style="display: none;">
    <div class="lose-alert">
        ğŸ˜” ê²Œì„ ì¢…ë£Œ! ì •ë‹µì„ í™•ì¸í•˜ì„¸ìš”.
    </div>
  </div>
<div id="finalMessage" class="final-message" style="display: none;">
    <div class="final-alert" id="finalAlert">
        ğŸŠ ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆì–´ìš”! ğŸŠ<br><br>
        ì´ <span id="totalQuestions"></span>ë¬¸ì œ<br>
        âœ… ë§íŒ: <span id="correctCount"></span>ê°œ<br>
        âŒ í‹€ë¦°: <span id="wrongCount"></span>ê°œ<br>
        ì •ë‹µë¥ : <span id="accuracy"></span>%

    <button class="retry-wrong-btn" id="retryWrongBtn" style="display: none;" onclick="retryWrongAnswers()">
        í‹€ë¦° ë¬¸ì œ <span id="wrongCountForRetry"></span>ê°œ ë‹¤ì‹œ í’€ê¸°
    </button>
    </div>

</div>
</div>
  <div class="consonant-section">
 <h3 class="consonant-title">
    <span class="title-text-desktop">ììŒì„ í´ë¦­í•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš” â†’</span>
    <span class="title-text-mobile">ììŒì„ í´ë¦­í•˜ì„¸ìš”</span>
   <input type="text" 
       class="consonant-input" 
       id="consonantInput" 
       maxlength="1" 
       autocomplete="off"
       autocorrect="off"
       autocapitalize="off"
       spellcheck="false"
       name="consonant-input-random">
</h3>
    <div class="consonant-grid" id="consonantGrid">
    </div>
  </div>
<div class="game-info">
    <div class="stats" id="gameStats">
        ë§ì¶˜ ììŒ: 0ê°œ | í‹€ë¦° ììŒ: 0ê°œ
    </div>
    <div style="display: flex; gap: 10px;">
          <button class="new-game-btn" onclick="location.href='https://soosooland.com/school/index.html'">ë‹¤ë¥¸ ê³µë¶€í•˜ê¸°</button>
    </div>
</div>

<script>
const dailyThemes = {
1: { bg: '#145454', white: '#F4F6F5', black: '#1B2B2B', primary: '#91b2c7', sub: '#2F4B5C', accent: '#E8956F', name: 'ì›”ìš”ì¼' },
2: { bg: '#145454', white: '#F4F6F5', black: '#1B2B2B', primary: '#7FA89A', sub: '#355F56', accent: '#c18ff2', name: 'í™”ìš”ì¼' },
3: { bg: '#145454', white: '#F7F5F0', black: '#2A2320', primary: '#B8C46F', sub: '#6B7A3F', accent: '#f7b2e3', name: 'ìˆ˜ìš”ì¼' },
4: { bg: '#145454', white: '#F7F5F0', black: '#2A2320', primary: '#D08A5A', sub: '#A85432', accent: '#5AB8D0', name: 'ëª©ìš”ì¼' },
5: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#fcdd95', sub: '#C8A24A', accent: '#a5cbfa', name: 'ê¸ˆìš”ì¼' },
6: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#ffaaa1', sub: '#9B4A4A', accent: '#6FD0B8', name: 'í† ìš”ì¼' },
0: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#9A8FBF', sub: '#4E3F73', accent: '#C5D08F', name: 'ì¼ìš”ì¼' }
};

function applyDailyTheme() {
    const today = new Date().getDay();
    const theme = dailyThemes[today];
    const root = document.documentElement;
    root.style.setProperty('--bg-color', theme.bg);
    root.style.setProperty('--white-color', theme.white);
    root.style.setProperty('--black-color', theme.black);
    root.style.setProperty('--primary-color', theme.primary);
    root.style.setProperty('--sub-color', theme.sub);
    root.style.setProperty('--accent-color', theme.accent);
}

applyDailyTheme();


const urlParams = new URLSearchParams(window.location.search);
const wordpoolUrl = urlParams.get('wordpool');
const categoryTitle = urlParams.get('title') || 'ëª¨ìŒ ìŠ¤ì¿¨';

// wordpool URLì—ì„œ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: "0-1-1-1")
function getWordpoolName() {
    if (!wordpoolUrl) return '';
    return wordpoolUrl.split('/').pop().replace('.json', '');
}

let sentences = [];
let originalSentences = [];
const consonants = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];

let totalQuestions = 0;
let wrongCount = 0; 
let wrongAnswers = [];           // í˜„ì¬ ë¼ìš´ë“œì—ì„œ í‹€ë¦° ë¬¸ì œ
let firstAttemptWrongAnswers = []; // 1ì°¨ ê³µë¶€ì—ì„œ í‹€ë¦° ë¬¸ì œ (ë³µìŠµìš©)
let guessedConsonants = new Set();
let wrongConsonants = new Set();
let gameWon = false;
let gameLost = false; 
let charStates = [];
let currentHint = '';
let currentSentence = '';
let shuffledSentences = [];
let sentenceIndex = 0;

// ===== í•µì‹¬ ìƒíƒœ ë³€ìˆ˜ =====
let gameMode = 'first';  // 'first' = 1ì°¨ê³µë¶€, 'first-retry' = 1ì°¨ í‹€ë¦°ë¬¸ì œ ì¬ì‹œë„, 'review' = ë³µìŠµ, 'review-retry' = ë³µìŠµ í‹€ë¦°ë¬¸ì œ ì¬ì‹œë„, 'practice' = ì—°ìŠµ
let currentReviewStep = 0; // 0=1ì°¨, 1=2ì°¨, 2=3ì°¨, 3=4ì°¨

async function loadWordpool() {
    if (!wordpoolUrl) {
        alert('ì›Œë“œí’€ ì£¼ì†Œê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return false;
    }

    try {
        const response = await fetch(wordpoolUrl);
        if (!response.ok) throw new Error('ì›Œë“œí’€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        sentences = await response.json();
        originalSentences = [...sentences];         
        if (!Array.isArray(sentences) || sentences.length === 0) {
            throw new Error('ì›Œë“œí’€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        return true;
    } catch (error) {
        alert('ì›Œë“œí’€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        return false;
    }
}

// ===== ì§„ë„/ë³µìŠµ ë°ì´í„° ê´€ë¦¬ =====

function getProgress(wpName) {
    try {
        const allProgress = JSON.parse(localStorage.getItem('moeumschool_progress') || '{}');
        return allProgress[wpName || getWordpoolName()] || { attempts: [] };
    } catch (error) {
        return { attempts: [] };
    }
}

function saveProgressData(wpName, progressData) {
    try {
        const allProgress = JSON.parse(localStorage.getItem('moeumschool_progress') || '{}');
        allProgress[wpName || getWordpoolName()] = progressData;
        localStorage.setItem('moeumschool_progress', JSON.stringify(allProgress));
    } catch (error) {
        console.error('ì§„ë„ ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

function getReviewData(wpName) {
    try {
        const allReviews = JSON.parse(localStorage.getItem('moeumschool_reviews') || '{}');
        return allReviews[wpName || getWordpoolName()] || null;
    } catch (error) {
        return null;
    }
}

function saveReviewData(wpName, reviewData) {
    try {
        const allReviews = JSON.parse(localStorage.getItem('moeumschool_reviews') || '{}');
        allReviews[wpName || getWordpoolName()] = reviewData;
        localStorage.setItem('moeumschool_reviews', JSON.stringify(allReviews));
    } catch (error) {
        console.error('ë³µìŠµ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

// ===== ğŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ =====
// true: ê°„ê²©ì„ ì´ˆ ë‹¨ìœ„ë¡œ (3ì¼â†’30ì´ˆ, 7ì¼â†’60ì´ˆ, 14ì¼â†’90ì´ˆ, 28ì¼â†’120ì´ˆ)
// false: ì›ë˜ ì¼ ë‹¨ìœ„
const TEST_MODE = false;
const TEST_INTERVALS_SEC = [30, 60, 90, 120]; // ì´ˆ ë‹¨ìœ„

function getTodayUTC() {
    if (TEST_MODE) {
        return Date.now(); // epoch ms
    }
    return new Date().toISOString().split('T')[0];
}

function addDays(dateStr, days) {
    if (TEST_MODE) {
        // daysëŠ” ì´ë¯¸ ì´ˆ ë‹¨ìœ„
        return dateStr + (days * 1000);
    }
    const d = new Date(dateStr + 'T00:00:00Z');
    d.setUTCDate(d.getUTCDate() + days);
    return d.toISOString().split('T')[0];
}

function getIntervals() {
    return TEST_MODE ? TEST_INTERVALS_SEC : [3, 7, 14, 28];
}

// ===== ê²Œì„ ëª¨ë“œ ê²°ì • =====
function determineGameMode() {
    const wpName = getWordpoolName();
    const progress = getProgress(wpName);
    const reviewData = getReviewData(wpName);
    const today = getTodayUTC();
    
    // ì•„ì§ ì‹œì‘ ì•ˆ í•¨
    if (progress.attempts.length === 0) {
        return { mode: 'first', step: 0 };
    }
    
    // ğŸ† íŠ¸ë¡œí”¼ (5íšŒ = ì²«íŒ ë§Œì  ë˜ëŠ” 5ì°¨ ë³µìŠµ ì™„ë£Œ)
    if (progress.attempts.length >= 5) {
        return { mode: 'trophy', step: 5 };
    }
    
    // ë³µìŠµ ë°ì´í„° í™•ì¸
    if (!reviewData || !reviewData.wrongQuestions || reviewData.wrongQuestions.length === 0) {
        return { mode: 'practice', step: progress.attempts.length };
    }
    
    // í˜„ì¬ ë³µìŠµ ë‹¨ê³„ í™•ì¸
    const completedReviews = reviewData.completedReviews || 0;
    // completedReviews: 0=1ì°¨ì™„ë£Œ, 1=2ì°¨ì™„ë£Œ, 2=3ì°¨ì™„ë£Œ, 3=4ì°¨ì™„ë£Œ, 4=5ì°¨ì™„ë£Œ
    
    if (completedReviews >= 4) {
        // 5ì°¨ ë³µìŠµê¹Œì§€ ì™„ë£Œ â†’ ì´ë¯¸ íŠ¸ë¡œí”¼ì—¬ì•¼ í•¨
        return { mode: 'trophy', step: 5 };
    }
    
    // ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ í™•ì¸
    const nextReviewDate = reviewData.nextReviewDate;
    if (!nextReviewDate) {
        // nextReviewDateê°€ ì—†ìœ¼ë©´ ì•„ì§ 1ì°¨ ì™„ë£Œ ì§í›„
        return { mode: 'waiting', step: completedReviews, nextDate: reviewData.nextReviewDate };
    }
    
    if (today >= nextReviewDate) {
        // ë³µìŠµ ê°€ëŠ¥!
        return { mode: 'review', step: completedReviews + 1 };
    } else {
        // ì•„ì§ ë³µìŠµ ì‹œê¸° ì•„ë‹˜
        let timeLeft;
        if (TEST_MODE) {
            const diffSec = Math.ceil((nextReviewDate - today) / 1000);
            timeLeft = `${diffSec}ì´ˆ`;
        } else {
            const diffMs = new Date(nextReviewDate + 'T00:00:00Z') - new Date(today + 'T00:00:00Z');
            timeLeft = `${Math.ceil(diffMs / (1000*60*60*24))}ì¼`;
        }
        return { mode: 'waiting', step: completedReviews, nextDate: nextReviewDate, timeLeft: timeLeft };
    }
}

// ===== ê²Œì„ ì‹œì‘ ì‹œ ëª¨ë“œ í™•ì¸ ë° ë¶„ê¸° =====
function initGameMode() {
    const modeInfo = determineGameMode();
    const wpName = getWordpoolName();
    const reviewData = getReviewData(wpName);
    
    console.log('ê²Œì„ ëª¨ë“œ:', modeInfo);
    
    switch (modeInfo.mode) {
        case 'first':
            // 1ì°¨ ê³µë¶€ - ì „ì²´ ë¬¸ì œ
            gameMode = 'first';
            currentReviewStep = 0;
            document.getElementById('reviewBanner').style.display = 'none';
            sentences = [...originalSentences];
            break;
            
        case 'review':
            // ë³µìŠµ ëª¨ë“œ - 1ì°¨ì—ì„œ í‹€ë¦° ë¬¸ì œë§Œ
            gameMode = 'review';
            currentReviewStep = modeInfo.step;
            const stepNames = ['', '2ì°¨ ë³µìŠµ', '3ì°¨ ë³µìŠµ', '4ì°¨ ë³µìŠµ', '5ì°¨ ë³µìŠµ'];
            const banner = document.getElementById('reviewBanner');
            banner.style.display = 'block';
            banner.textContent = `ğŸ“ ${stepNames[modeInfo.step] || 'ë³µìŠµ'} - 1ì°¨ ê³µë¶€ì—ì„œ í‹€ë¦° ë¬¸ì œë¥¼ ë³µìŠµí•©ë‹ˆë‹¤`;
            
            // 1ì°¨ì—ì„œ í‹€ë¦° ë¬¸ì œë§Œ ë¡œë“œ
            sentences = reviewData.wrongQuestions.map(q => ({ text: q.text, hint: q.hint }));
            break;
            
        case 'trophy':
            // ğŸ† íŠ¸ë¡œí”¼ ë³´ìœ  - ë°˜ë‚©í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ í’€ ìˆ˜ ìˆìŒ
            const resetChoice = window.confirm('ğŸ† í•™ìŠµ ì™„ë£Œ! íŠ¸ë¡œí”¼ë¥¼ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n[í™•ì¸] íŠ¸ë¡œí”¼ë¥¼ ë°˜ë‚©í•˜ê³  ì²˜ìŒë¶€í„° ê³µë¶€\n[ì·¨ì†Œ] íŠ¸ë¡œí”¼ë¥¼ ì§€í‚¤ê³  ë‹¤ë¥¸ ê³µë¶€í•˜ê¸°');
            if (resetChoice) {
                const wpNameTrophy = getWordpoolName();
                // progress ì´ˆê¸°í™”
                saveProgressData(wpNameTrophy, { attempts: [] });
                // review ë°ì´í„° ì™„ì „ ì‚­ì œ
                try {
                    const allReviews = JSON.parse(localStorage.getItem('moeumschool_reviews') || '{}');
                    delete allReviews[wpNameTrophy];
                    localStorage.setItem('moeumschool_reviews', JSON.stringify(allReviews));
                } catch (e) { console.error(e); }
                
                gameMode = 'first';
                currentReviewStep = 0;
                document.getElementById('reviewBanner').style.display = 'none';
                sentences = [...originalSentences];
            } else {
                location.href = 'https://soosooland.com/school/index.html';
                return;
            }
            break;
            
        case 'practice':
            // ì—°ìŠµ ëª¨ë“œ (ë¹„ì •ìƒ ìƒíƒœ ë“±)
            gameMode = 'practice';
            document.getElementById('reviewBanner').style.display = 'none';
            sentences = [...originalSentences];
            break;
            
        case 'waiting':
            // ì•„ì§ ë³µìŠµ ì‹œê¸°ê°€ ì•„ë‹˜
            alert(`â° ì•„ì§ ë³µìŠµ ì‹œê¸°ê°€ ì•„ë‹™ë‹ˆë‹¤!\n\në‹¤ìŒ ë³µìŠµ: ${modeInfo.timeLeft} í›„ (${modeInfo.nextDate})\nê°„ê²©ì„ ì§€ì¼œì•¼ íš¨ê³¼ì ìœ¼ë¡œ ê¸°ì–µí•  ìˆ˜ ìˆì–´ìš”.`);
            location.href = 'https://soosooland.com/school/index.html';
            return;
            
        default:
            gameMode = 'first';
            sentences = [...originalSentences];
            break;
    }
    
    wrongCount = 0;
    wrongAnswers = [];
    firstAttemptWrongAnswers = [];
    
    shuffleSentences();
    document.querySelector('.game-board').style.display = 'block';
    document.getElementById('finalMessage').style.display = 'none';
    startRound();
}

function shuffleSentences() {
    shuffledSentences = [...sentences];
    for (let i = shuffledSentences.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledSentences[i], shuffledSentences[j]] = [shuffledSentences[j], shuffledSentences[i]];
    }
    sentenceIndex = 0;
    totalQuestions = shuffledSentences.length;
}

function getNextSentence() {
    if (sentenceIndex >= shuffledSentences.length) return null;
    return shuffledSentences[sentenceIndex++];
}

function containsConsonant(targetChar, consonant) {
    const consonantMap = { 'ã„²': 'ã„±', 'ã„¸': 'ã„·', 'ã…ƒ': 'ã…‚', 'ã…†': 'ã……', 'ã…‰': 'ã…ˆ' };
    const complexConsonantMap = {
        'ã„³': ['ã„±', 'ã……'], 'ã„µ': ['ã„´', 'ã…ˆ'], 'ã„¶': ['ã„´', 'ã…'],
        'ã„º': ['ã„¹', 'ã„±'], 'ã„»': ['ã„¹', 'ã…'], 'ã„¼': ['ã„¹', 'ã…‚'],
        'ã„½': ['ã„¹', 'ã……'], 'ã„¾': ['ã„¹', 'ã…Œ'], 'ã„¿': ['ã„¹', 'ã…'],
        'ã…€': ['ã„¹', 'ã…'], 'ã…„': ['ã…‚', 'ã……']
    };
    if (targetChar === consonant) return true;
    if (consonantMap[targetChar] === consonant) return true;
    if (complexConsonantMap[targetChar] && complexConsonantMap[targetChar].includes(consonant)) return true;
    return false;
}

function getComplexConsonantComponents(consonant) {
    const complexConsonantMap = {
        'ã„³': ['ã„±', 'ã……'], 'ã„µ': ['ã„´', 'ã…ˆ'], 'ã„¶': ['ã„´', 'ã…'],
        'ã„º': ['ã„¹', 'ã„±'], 'ã„»': ['ã„¹', 'ã…'], 'ã„¼': ['ã„¹', 'ã…‚'],
        'ã„½': ['ã„¹', 'ã……'], 'ã„¾': ['ã„¹', 'ã…Œ'], 'ã„¿': ['ã„¹', 'ã…'],
        'ã…€': ['ã„¹', 'ã…'], 'ã…„': ['ã…‚', 'ã……']
    };
    return complexConsonantMap[consonant] || null;
}

function decomposeHangul(char) {
    const code = char.charCodeAt(0) - 0xAC00;
    if (code < 0 || code > 11171) return null;
    const jong = code % 28;
    const jung = (code - jong) / 28 % 21;
    const cho = ((code - jong) / 28 - jung) / 21;
    const choTable = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    const jungTable = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
    const jongTable = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    return {
        cho: choTable[cho],
        jung: jungTable[jung],
        jong: jong === 0 ? '' : jongTable[jong]
    };
}

function composeHangul(cho, jung, jong = '') {
    const choTable = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    const jungTable = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
    const jongTable = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    
    const choIndex = choTable.indexOf(cho);
    const jungIndex = jungTable.indexOf(jung);
    const jongIndex = jongTable.indexOf(jong);
    if (choIndex === -1 || jungIndex === -1 || jongIndex === -1) return null;
    const code = 0xAC00 + (choIndex * 21 + jungIndex) * 28 + jongIndex;
    return String.fromCharCode(code);
}

function isJongComplete(charData) {
    if (!charData.jong) return true;
    const doubleConsonantMap = { 'ã„²': 'ã„±', 'ã…†': 'ã……' };
    if (doubleConsonantMap[charData.jong]) {
        const baseConsonant = doubleConsonantMap[charData.jong];
        return charData.foundJongComponents.has(baseConsonant) || charData.foundJongComponents.has(charData.jong);
    }
    const components = getComplexConsonantComponents(charData.jong);
    if (!components) {
        return charData.foundJongComponents.has(charData.jong);
    } else {
        return components.every(comp => charData.foundJongComponents.has(comp));
    }
}

function isCharComplete(charData) {
    return charData.choFound && isJongComplete(charData);
}

function createConsonantButtons() {
    const grid = document.getElementById('consonantGrid');
    grid.innerHTML = '';
    consonants.forEach(consonant => {
        const button = document.createElement('button');
        button.className = 'consonant-btn available';
        button.textContent = consonant;
        button.onclick = () => handleConsonantClick(consonant);
        button.id = `btn-${consonant}`;
        grid.appendChild(button);
    });
    
    const input = document.getElementById('consonantInput');
    if (input) {
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        
        newInput.addEventListener('input', function(e) {
            const value = e.target.value;
            if (value && consonants.includes(value)) {
                handleConsonantClick(value);
                setTimeout(() => { e.target.value = ''; }, 100);
            }
        });
        
        newInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (gameWon) {
                    nextRound();
                }
            }
        });
        
        setTimeout(() => { newInput.focus(); }, 100);
    }
}

function getFoundJongDisplay(charData) {
    if (!charData.jong) return '';
    const doubleConsonantMap = { 'ã„²': 'ã„±', 'ã…†': 'ã……' };
    if (doubleConsonantMap[charData.jong]) {
        const baseConsonant = doubleConsonantMap[charData.jong];
        if (charData.foundJongComponents.has(baseConsonant) || charData.foundJongComponents.has(charData.jong)) {
            return charData.jong;
        }
        return '';
    }
    const components = getComplexConsonantComponents(charData.jong);
    if (!components) {
        return charData.foundJongComponents.has(charData.jong) ? charData.jong : '';
    } else {
        const foundParts = components.filter(comp => charData.foundJongComponents.has(comp));
        if (foundParts.length === 0) return '';
        if (foundParts.length === components.length) return charData.jong;
        else return foundParts.join('');
    }
}

function updateDisplay() {
    const words = [];
    let currentWord = [];

    charStates.forEach(charData => {
        if (charData.isSpace) {
            if (currentWord.length > 0) {
                words.push(currentWord);
                currentWord = [];
            }
        } else {
            if (charData.isNonHangul) {
                currentWord.push(`<span class="hangul-char complete-char">${charData.char}</span>`);
            } else {
                let displayCho = charData.choFound ? charData.cho : '';
                let displayJung = charData.jung;
                let displayJong = getFoundJongDisplay(charData);

                if (displayCho && displayJong) {
                    currentWord.push(`<span class="hangul-char complete-char">${composeHangul(displayCho, displayJung, displayJong)}</span>`);
                } else if (displayCho && !charData.jong) {
                    currentWord.push(`<span class="hangul-char complete-char">${composeHangul(displayCho, displayJung)}</span>`);
                } else if (displayCho) {
                    currentWord.push(`<span class="hangul-char incomplete-char">${composeHangul(displayCho, displayJung)}</span>`);
                } else if (displayJong) {
                    currentWord.push(`<span class="hangul-char incomplete-char" style="position: relative; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; min-width: 1em; height: 1.2em;"><span style="font-size: 0.8em;">${displayJung}</span><span style="font-size: 0.7em; margin-top: -0.1em;">${displayJong}</span></span>`);
                } else {
                    currentWord.push(`<span class="hangul-char incomplete-char">${displayJung}</span>`);
                }
            }
        }
    });

    if (currentWord.length > 0) words.push(currentWord);
    const wordGroups = words.map(word => `<span class="word-group">${word.join('')}</span>`);
    document.getElementById('sentenceArea').innerHTML = wordGroups.join('');
}

function handleConsonantClick(consonant) {
    if (guessedConsonants.has(consonant) || wrongConsonants.has(consonant) || gameWon || gameLost) return;

    let found = false;
    charStates.forEach(charData => {
        if (charData.isSpace || charData.isNonHangul) return;
        
        if (!charData.choFound && containsConsonant(charData.cho, consonant)) {
            charData.choFound = true;
            found = true;
        }
        
        if (charData.jong && containsConsonant(charData.jong, consonant)) {
            if (!charData.foundJongComponents.has(consonant)) {
                charData.foundJongComponents.add(consonant);
                found = true;
                if (isJongComplete(charData)) charData.jongFound = true;
            }
        }
    });

    if (found) {
        guessedConsonants.add(consonant);
        document.getElementById(`btn-${consonant}`).className = 'consonant-btn correct';
        updateDisplay();
        const allComplete = charStates.every(charData =>
            charData.isSpace || charData.isNonHangul || isCharComplete(charData)
        );

        if (allComplete) {
            gameWon = true;
            
            // 1ì°¨ ê³µë¶€ì—ì„œ ììŒì„ í‹€ë¦° ë¬¸ì œ ê¸°ë¡
            if (gameMode === 'first' && wrongConsonants.size > 0) {
                firstAttemptWrongAnswers.push({text: currentSentence, hint: currentHint});
            }
            
            // í˜„ì¬ ë¼ìš´ë“œì—ì„œ í‹€ë¦° ë¬¸ì œ ê¸°ë¡ (ì¬ì‹œë„ìš©)
            if (wrongConsonants.size > 0) {
                wrongAnswers.push({text: currentSentence, hint: currentHint});
                wrongCount++;
            }
            
            document.getElementById('winMessage').style.display = 'block';
        }

    } else { 
        wrongConsonants.add(consonant);
        document.getElementById(`btn-${consonant}`).className = 'consonant-btn wrong';
    }

    updateStats();
} 

function updateStats() {
    document.getElementById('gameStats').innerHTML =
        `ë§ì¶˜ ììŒ: ${guessedConsonants.size}ê°œ | í‹€ë¦° ììŒ: ${wrongConsonants.size}ê°œ`;
}

function startRound() {
    const randomSentenceData = getNextSentence();
    
    if (!randomSentenceData) {
        showFinalScore();
        return;
    }
    
    currentSentence = randomSentenceData.text;
    currentHint = randomSentenceData.hint;
    guessedConsonants = new Set();
    wrongConsonants = new Set();
    gameWon = false;
    gameLost = false;
    charStates = [];
    
    document.getElementById('winMessage').style.display = 'none';
    document.getElementById('loseMessage').style.display = 'none';
    document.getElementById('finalMessage').style.display = 'none';
    document.getElementById('hintText').innerHTML = wrapEmojis(currentHint);

    document.getElementById('roundDisplay').textContent = `ë¬¸ì œ ${sentenceIndex}/${totalQuestions}`;
    document.getElementById('scoreDisplay').textContent = `ì˜¤ë‹µ: ${wrongCount}ê°œ`;
   
    for (let char of currentSentence) {
        if (char === ' ') {
            charStates.push({ isSpace: true });
        } else {
            const decomposed = decomposeHangul(char);
            if (!decomposed) {
                charStates.push({ isNonHangul: true, char });
            } else {
                charStates.push({
                    char,
                    cho: decomposed.cho,
                    jung: decomposed.jung,
                    jong: decomposed.jong,
                    choFound: false,
                    jongFound: false,
                    foundJongComponents: new Set(),
                    isSpace: false,
                    isNonHangul: false
                });
            }
        }
    }

    updateDisplay();
    createConsonantButtons();
    updateStats();
}

function nextRound() {
    startRound();
    setTimeout(() => {
        const input = document.getElementById('consonantInput');
        if (input) input.focus();
    }, 200);
}

function showFinalScore() {
    const correct = totalQuestions - wrongCount;
    const accuracy = Math.round((correct / totalQuestions) * 100);
    
    document.getElementById('totalQuestions').textContent = totalQuestions;
    document.getElementById('correctCount').textContent = correct;
    document.getElementById('wrongCount').textContent = wrongCount;
    document.getElementById('accuracy').textContent = accuracy;
    
    document.querySelector('.game-board').style.display = 'none';
    document.getElementById('finalMessage').style.display = 'block';
    
    // í‹€ë¦° ë¬¸ì œê°€ ìˆìœ¼ë©´ "ë‹¤ì‹œ í’€ê¸°" ë²„íŠ¼ í‘œì‹œ
    if (wrongCount > 0) {
        document.getElementById('wrongCountForRetry').textContent = wrongCount;
        document.getElementById('retryWrongBtn').style.display = 'inline-block';
    } else {
        document.getElementById('retryWrongBtn').style.display = 'none';
        
        // í‹€ë¦° ë¬¸ì œ 0ê°œ = ì´ ë‹¨ê³„ ì™„ë£Œ!
        handleStageComplete();
    }
}

// ===== ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬ (í•µì‹¬ ë¡œì§) =====
function handleStageComplete() {
    const wpName = getWordpoolName();
    const today = getTodayUTC();
    
    if (gameMode === 'practice') {
        // ì—°ìŠµ ëª¨ë“œ - ì•„ë¬´ê²ƒë„ ì €ì¥ ì•ˆ í•¨
        const finalAlert = document.getElementById('finalAlert');
        const practiceMsg = document.createElement('div');
        practiceMsg.style.marginTop = '15px';
        practiceMsg.style.fontSize = '1.1em';
        practiceMsg.style.color = '#FF9800';
        practiceMsg.innerHTML = 'ğŸ† ì—°ìŠµ ëª¨ë“œ - ê¸°ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
        finalAlert.appendChild(practiceMsg);
        return;
    }
    
    if (gameMode === 'first' || gameMode === 'first-retry') {
        // === 1ì°¨ ê³µë¶€ ì™„ë£Œ ===
        
        if (firstAttemptWrongAnswers.length === 0) {
            // ğŸ† 1ì°¨ ê³µë¶€ì—ì„œ í•œ ë¬¸ì œë„ ì•ˆ í‹€ë¦¼ â†’ íŠ¸ë¡œí”¼!
            const progress = getProgress(wpName);
            progress.attempts = [
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 }
            ];
            saveProgressData(wpName, progress);
            
            const finalAlert = document.getElementById('finalAlert');
            const trophyMsg = document.createElement('div');
            trophyMsg.style.marginTop = '15px';
            trophyMsg.style.fontSize = '1.3em';
            trophyMsg.innerHTML = 'ğŸ† ì™„ë²½í•©ë‹ˆë‹¤! íŠ¸ë¡œí”¼ íšë“! ğŸ†<br>ë³µìŠµì´ í•„ìš” ì—†ì–´ìš”!';
            finalAlert.appendChild(trophyMsg);
            
            console.log('ğŸ† 1ì°¨ ë§Œì ! íŠ¸ë¡œí”¼ íšë“!');
        } else {
            // 1ì°¨ ê³µë¶€ì—ì„œ í‹€ë¦° ë¬¸ì œê°€ ìˆì—ˆìŒ â†’ 1ì°¨ ì™„ë£Œ + ë³µìŠµ ì¼ì • ì €ì¥
            const progress = getProgress(wpName);
            progress.attempts.push({ date: today, accuracy: Math.round(((totalQuestions - firstAttemptWrongAnswers.length) / totalQuestions) * 100) });
            saveProgressData(wpName, progress);
            
            // ë³µìŠµ ë°ì´í„° ì €ì¥: 1ì°¨ì—ì„œ í‹€ë¦° ë¬¸ì œ + ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ
            const reviewData = {
                wrongQuestions: firstAttemptWrongAnswers.map(q => ({ text: q.text, hint: q.hint })),
                firstStudyDate: today,
                completedReviews: 0,
                nextReviewDate: addDays(today, getIntervals()[0]),  // 3ì¼(ë˜ëŠ” 1ë¶„) í›„ 2ì°¨ ë³µìŠµ
                reviewHistory: [
                    { step: 1, date: today }  // 1ì°¨ ì™„ë£Œ ê¸°ë¡
                ]
            };
            saveReviewData(wpName, reviewData);
            
            const finalAlert = document.getElementById('finalAlert');
            const reviewMsg = document.createElement('div');
            reviewMsg.style.marginTop = '15px';
            reviewMsg.style.fontSize = '1.1em';
            reviewMsg.style.color = '#2196F3';
            reviewMsg.innerHTML = `ğŸ“ 1ì°¨ ê³µë¶€ ì™„ë£Œ!<br>í‹€ë¦° ${firstAttemptWrongAnswers.length}ë¬¸ì œëŠ” ${TEST_MODE ? getIntervals()[0]+'ì´ˆ' : '3ì¼'} í›„ì— ë³µìŠµí•©ë‹ˆë‹¤.`;
            finalAlert.appendChild(reviewMsg);
            
            console.log('1ì°¨ ì™„ë£Œ! í‹€ë¦° ë¬¸ì œ:', firstAttemptWrongAnswers.length, 'ë‹¤ìŒ ë³µìŠµ:', addDays(today, 3));
        }
    }
    else if (gameMode === 'review' || gameMode === 'review-retry') {
        // === ë³µìŠµ ì™„ë£Œ ===
        const wpName = getWordpoolName();
        const progress = getProgress(wpName);
        const reviewData = getReviewData(wpName);
        
        if (!reviewData) return;
        
        // ë³µìŠµ ì™„ë£Œ íšŸìˆ˜ ì¦ê°€
        reviewData.completedReviews = (reviewData.completedReviews || 0) + 1;
        
        // ë³µìŠµ íˆìŠ¤í† ë¦¬ ê¸°ë¡
        if (!reviewData.reviewHistory) reviewData.reviewHistory = [];
        reviewData.reviewHistory.push({ step: reviewData.completedReviews + 1, date: today });
        
        // progressì— attempt ì¶”ê°€ (ë‚ ì§œëŠ” ì˜¤ëŠ˜, 1ì°¨ ë‚ ì§œ ë³´ì¡´)
        progress.attempts.push({ date: today, accuracy: 100 });
        
        // ë‹¤ìŒ ë³µìŠµ ê°„ê²© ê³„ì‚° (ì´ë²ˆ ë³µìŠµ ì™„ë£Œì¼ ê¸°ì¤€!)
        const intervals = getIntervals();
        // completedReviews: 1=2ì°¨ì™„ë£Œ, 2=3ì°¨ì™„ë£Œ, 3=4ì°¨ì™„ë£Œ, 4=5ì°¨ì™„ë£Œ
        
        const stepNames = ['2ì°¨', '3ì°¨', '4ì°¨', '5ì°¨'];
        const currentStepName = stepNames[reviewData.completedReviews - 1] || '';
        
        if (reviewData.completedReviews >= 4) {
            // 5ì°¨ ë³µìŠµ ì™„ë£Œ â†’ ğŸ† íŠ¸ë¡œí”¼!
            while (progress.attempts.length < 5) {
                progress.attempts.push({ date: today, accuracy: 100 });
            }
            saveProgressData(wpName, progress);
            
            reviewData.nextReviewDate = null;
            saveReviewData(wpName, reviewData);
            
            const finalAlert = document.getElementById('finalAlert');
            const trophyMsg = document.createElement('div');
            trophyMsg.style.marginTop = '15px';
            trophyMsg.style.fontSize = '1.3em';
            trophyMsg.innerHTML = 'ğŸ† 5ì°¨ ë³µìŠµ ì™„ë£Œ! ì¥ê¸°ê¸°ì–µ ì™„ì„±! ğŸ†';
            finalAlert.appendChild(trophyMsg);
            
            console.log('ğŸ† 5ì°¨ ë³µìŠµ ì™„ë£Œ! íŠ¸ë¡œí”¼!');
        } else {
            // ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ ê¸°ì¤€!)
            const nextInterval = intervals[reviewData.completedReviews]; // completedReviews=1ì´ë©´ intervals[1]=7
            reviewData.nextReviewDate = addDays(today, nextInterval);
            
            saveProgressData(wpName, progress);
            saveReviewData(wpName, reviewData);
            
            const nextStepNames = ['3ì°¨', '4ì°¨', '5ì°¨'];
            const nextStepName = nextStepNames[reviewData.completedReviews - 1] || 'ë‹¤ìŒ';
            
            const finalAlert = document.getElementById('finalAlert');
            const reviewMsg = document.createElement('div');
            reviewMsg.style.marginTop = '15px';
            reviewMsg.style.fontSize = '1.1em';
            reviewMsg.style.color = '#2196F3';
            reviewMsg.innerHTML = `âœ… ${currentStepName} ë³µìŠµ ì™„ë£Œ!<br>${nextStepName} ë³µìŠµ: ${nextInterval}ì¼ í›„ (${reviewData.nextReviewDate})`;
            finalAlert.appendChild(reviewMsg);
            
            console.log(`${currentStepName} ë³µìŠµ ì™„ë£Œ! ë‹¤ìŒ:`, reviewData.nextReviewDate);
        }
    }
}

// í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸° (í˜„ì¬ ë¼ìš´ë“œì—ì„œ í‹€ë¦° ê²ƒ)
function retryWrongAnswers() {
    sentences = [...wrongAnswers];
    wrongAnswers = [];
    wrongCount = 0;
    
    // ëª¨ë“œ ìœ ì§€ (1ì°¨ë©´ first-retry, ë³µìŠµì´ë©´ review-retry)
    if (gameMode === 'first') {
        gameMode = 'first-retry';
        // firstAttemptWrongAnswersëŠ” ìœ ì§€! (1ì°¨ì—ì„œ í‹€ë¦° ì›ë³¸ ê¸°ë¡)
    } else if (gameMode === 'review') {
        gameMode = 'review-retry';
    }
    // first-retry, review-retryëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
    
    shuffleSentences();
    document.querySelector('.game-board').style.display = 'block';
    document.getElementById('finalMessage').style.display = 'none';
    startRound();
}

function wrapEmojis(text) {
    if (!text) return '';
    return text.replace(/([\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F100}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}])/gu, '<span class="emoji">$1</span>');
}

window.onload = async function () {
    const success = await loadWordpool();
    if (success) {
        document.getElementById('categoryTitle').textContent = categoryTitle;
        createConsonantButtons();
        initGameMode();
    }
};

</script>

</body>
</html>
