<!DOCTYPE html>
<html lang="ko">
<head>
 <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4YZHC1G9FN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4YZHC1G9FN');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ëª¨ìŒìŠ¤ì¿¨ - ì´ˆë“±í•™ìƒ í•™ìŠµ í€´ì¦ˆ | Soosooland</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ì´ˆë“±í•™êµ êµìœ¡ê³¼ì •ì—ì„œ ë°°ìš°ëŠ” ë‚´ìš©ì„ í€´ì¦ˆë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ì—ë¹™í•˜ìš°ìŠ¤ ë§ê°ê³¡ì„ ì„ ì ìš©í•œ ê³¼í•™ì  ë°˜ë³µ í•™ìŠµìœ¼ë¡œ ê¸°ì–µë ¥ í–¥ìƒ">
    <meta name="keywords" content="ê¸°ì–µë ¥ í–¥ìƒ, ë°˜ë³µ í•™ìŠµ, ì´ˆë“±êµìœ¡ê³¼ì •, ì´ˆë“±êµìœ¡, ëª¨ìŒìŠ¤ì¿¨, ì´ˆë“±í€´ì¦ˆ, ì—ë¹™í•˜ìš°ìŠ¤">
    <meta name="author" content="Soosooland">
    
    <!-- Open Graph -->
    <meta property="og:title" content="ëª¨ìŒìŠ¤ì¿¨ - ì´ˆë“±í•™ìƒ í•™ìŠµ í€´ì¦ˆ">
    <meta property="og:description" content="ì´ˆë“±í•™êµ êµìœ¡ê³¼ì • ê¸°ë°˜ í•™ìŠµ í€´ì¦ˆ. ì—ë¹™í•˜ìš°ìŠ¤ ë§ê°ê³¡ì„ ì„ ì ìš©í•œ ê³¼í•™ì  ë°˜ë³µ í•™ìŠµìœ¼ë¡œ ê¸°ì–µë ¥ í–¥ìƒ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://soosooland.com/school/school.html">
    <link rel="canonical" href="https://soosooland.com/school/school.html">
    <link rel="stylesheet" href="https://soosooland.com/css/protection.css">
    <script src="https://soosooland.com/js/protection.js"></script>
<style>
        :root {
            /* ìš”ì¼ë³„ë¡œ ë³€ê²½ë˜ëŠ” ìƒ‰ìƒ - ê¸°ë³¸ê°’ (ì›”ìš”ì¼) */
            --bg-color: #145454;
            --white-color: #F4F6F5;
            --black-color: #1B2B2B;
            --primary-color: #6F8FA3;
            --sub-color: #2F4B5C;
            --accent-color: #2F4B5C;
        }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

body {
font-family: 'Malgun Gothic', sans-serif;
background: var(--bg-color);
min-height: 100vh;
padding: 20px;
}

.container {
max-width: 750px;
margin: 0 auto;
}

.header {
text-align: center;
margin-bottom: 30px;
}
.title {
font-size: 1.8em;
font-weight: bold;
color: var(--white-color);
margin-bottom: 10px;
}  
.subtitle {
color: var(--primary-color);
font-size: 1.4em;
font-weight: bold;
margin-bottom: 5px;
}

.game-desc {
color: var(--white-color);
font-size: 1.1em;
}

.game-board {
background: var(--white-color);
border-radius: 12px;
padding: 30px;
margin-bottom: 20px;
}

.round-section {
background: var(--primary-color);
border-radius: 8px;
padding: 10px;
margin-bottom: 15px;
display: flex;
justify-content: space-between;
align-items: center;
color: var(--black-color);
}

.round-display {
font-size: 1.3em;
color: var(--black-color);
font-weight: bold;
}

.score-display {
font-size: 1.3em;
color: var(--black-color);
font-weight: bold;
}

.next-round-btn {
background: var(--sub-color);
color: var(--white-color);
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1.1em;
margin-top: 15px;
transition: all 0.3s ease;
}

.next-round-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.final-message {
text-align: center;
margin-bottom: 20px;
}

.final-alert {
background: var(--white-color);
border: 2px solid var(--primary-color);
color: var(--black-color);
padding: 20px;
border-radius: 8px;
font-size: 1.4em;
font-weight: bold;
}

.retry-wrong-btn {
background: var(--accent-color);
color: var(--white-color);
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1.1em;
transition: all 0.3s ease;
}

.sentence-display {
text-align: center;
margin-bottom: 20px;
}

.sentence-area {
font-size: 3em;
background: var(--white-color);
padding: 15px;
border-radius: 8px;
min-height: 120px;
display: flex;
align-items: center;
justify-content: center;
flex-wrap: wrap;
gap: 10px;
line-height: 1.2;
word-break: keep-all;
overflow-wrap: break-word;
}

.word-group {
display: inline-flex;
flex-wrap: nowrap;
white-space: nowrap;
align-items: center;
margin-right: 0.3em;
color: var(--black-color);
}

.word-group:last-child {
margin-right: 0;
}

.hangul-char {
display: inline-block;
min-width: 1em;
height: 1.2em;
text-align: center;
vertical-align: baseline;
font-family: 'Malgun Gothic', sans-serif;
}

.incomplete-char {
background: var(--white-color);
color: var(--black-color);
display: inline-flex;
align-items: center;
justify-content: center;
min-width: 1em;
height: 1.2em;
}

.complete-char {
color: var(--black-color);
}

.space {
width: 0.5em;
}

.win-message {
text-align: center;
margin-bottom: 20px;
}

.win-alert {
background: var(--white-color);
border: 1px solid var(--primary-color);
color: var(--black-color);
padding: 15px;
border-radius: 8px;
font-size: 1.2em;
}

.lose-message {
text-align: center;
margin-bottom: 20px;
}

.lose-alert {
background: var(--primary-color);
border: 1px solid var(--primary-color);
color: var(--black-color);
padding: 15px;
border-radius: 8px;
font-size: 1.2em;
}

.wrong-attempts {
background: var(--primary-color);
color: var(--black-color);
padding: 8px 12px;
border-radius: 6px;
font-weight: bold;
margin-left: 10px;
}

.hint-section {
  background: var(--sub-color);
  color: var(--white-color);
  padding: 15px;
  margin-bottom: 10px;
  text-align: center;
}

.hint-title {
  font-size: 1.2em;
  color: var(--white-color);
  font-weight: bold;
  margin-bottom: 5px;
  display: inline;
}

.hint-text {
  font-size: 1.3em;
  color: var(--white-color);
  font-weight: bold;
  display: inline;
}

.hint-text .emoji {
  font-size: 2em;
  vertical-align: middle;
}

.consonant-section {
background: var(--white-color);
border-radius: 12px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
padding: 30px;
margin-bottom: 20px;
max-width: 750px;
margin: 0 auto 20px auto;  
}

.consonant-title {
font-size: 1.2em;
font-weight: 600;
margin-bottom: 20px;
text-align: center;
color: var(--black-color);
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
flex-wrap: wrap;
}

.title-text-desktop {
display: inline;
}

.title-text-mobile {
display: none;
}

.consonant-input {
width: 50px;
height: 40px;
font-size: clamp(16px, 1.5em, 24px);
text-align: center;
border: 2px solid var(--primary-color);
border-radius: 8px;
padding: 5px;
font-family: 'Malgun Gothic', sans-serif;
background: white;
color: var(--black-color);
}

.consonant-input:focus {
outline: none;
border-color: var(--sub-color);
box-shadow: 0 0 5px var(--sub-color);
}

.consonant-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 10px;
}

.consonant-btn {
width: 60px;
height: 60px;
font-size: 1.4em;
font-weight: bold;
border-radius: 8px;
border: 2px solid;
cursor: pointer;
transition: all 0.2s;
}

.consonant-btn.available {
background: var(--primary-color);
color:var(--black-color);
}

.consonant-btn.available:hover {
background: linear-gradient(135deg, #7AB2D3, #B9E5E8);
color: white;
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(74, 98, 138, 0.3);
}

.consonant-btn.correct {
background:var(--white-color);
color: var(--black-color);
border-color: #4A628A;
}

.consonant-btn.wrong {
background:var(--white-color);
color: var(--black-color);
border-color: var(--primary-color);
cursor: not-allowed;
}

.game-info {
display: flex;
justify-content: space-between;
align-items: center;
background: var(--bg-color);
padding: 10px;
margin-bottom: 20px;
max-width: 750px;
margin: 0 auto 20px auto;
}

.stats {
font-size: 1.3em;
font-weight: bold;
color: var(--primary-color);
}

.new-game-btn {
background: var(--accent-color);
color: var(--white-color);
padding: 10px 20px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 1em;
transition: all 0.3s ease;
}

.new-game-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

@media (max-width: 600px) {
.title {
font-size: 1.8em;
}
.sentence-area {
font-size: 1.8em;
padding: 20px;
min-height: 80px;
}

.consonant-grid {
    grid-template-columns: repeat(5, 1fr);
}

.consonant-btn {
    width: 100%;
    height: 50px;
    font-size: 1.0em;
}

.new-game-btn {
    width: 100%;
    padding: 12px 0;
    font-size: 1em;
}

.game-info {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
}

.game-info > div {
    width: 100%;
}

.container {
    padding: 10px;
}

.consonant-title {
    font-size: 1em;
    flex-direction: column;
    gap: 5px;
}
.title-text-desktop {
    display: none;
}

.title-text-mobile {
    display: inline;
}

.consonant-input {
    width: 60px;
    height: 45px;
    display: none;
}    
}

</style>

</head>
<body>
<div class="container">
 <div class="header">
    <h1 class="title">ëª¨ìŒ ìŠ¤ì¿¨</h1>
    <p class="subtitle" id="categoryTitle">ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
</div>

  <div class="game-board">
    <div class="round-section">
      <div class="round-display" id="roundDisplay">ë¬¸ì œ 1/10</div>
      <div class="score-display" id="scoreDisplay">ì •ë‹µ: 0/10</div>
    </div>

<div class="hint-section">
  <div class="hint-title">ğŸ’¡ </div>
  <div class="hint-text" id="hintText">ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
</div>
<div class="sentence-display">
  <div class="sentence-area" id="sentenceArea">
    ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!
  </div>
</div>
<div id="winMessage" class="win-message" style="display: none;">
<div class="win-alert">
    ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰
</div>
<button class="next-round-btn" onclick="nextRound()">ë‹¤ìŒ ë¬¸ì œ â†’</button>

</div>
  </div>
  <div id="loseMessage" class="lose-message" style="display: none;">
    <div class="lose-alert">
        ğŸ˜” ê²Œì„ ì¢…ë£Œ! ì •ë‹µì„ í™•ì¸í•˜ì„¸ìš”.
    </div>
  </div>
<div id="finalMessage" class="final-message" style="display: none;">
    <div class="final-alert">
        ğŸŠ ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆì–´ìš”! ğŸŠ<br><br>
        ì´ <span id="totalQuestions"></span>ë¬¸ì œ<br>
        âœ… ë§íŒ: <span id="correctCount"></span>ê°œ<br>
        âŒ í‹€ë¦°: <span id="wrongCount"></span>ê°œ<br>
        ì •ë‹µë¥ : <span id="accuracy"></span>%

    <button class="retry-wrong-btn" id="retryWrongBtn" style="display: none;" onclick="retryWrongAnswers()">
        í‹€ë¦° ë¬¸ì œ <span id="wrongCountForRetry"></span>ê°œ ë‹¤ì‹œ í’€ê¸°
    </button>
    <button class="next-round-btn" onclick="restartGame()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
</div>

</div>
</div>
  <div class="consonant-section">
 <h3 class="consonant-title">
    <span class="title-text-desktop">ììŒì„ í´ë¦­í•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš” â†’</span>
    <span class="title-text-mobile">ììŒì„ í´ë¦­í•˜ì„¸ìš”</span>
   <input type="text" 
       class="consonant-input" 
       id="consonantInput" 
       maxlength="1" 
       autocomplete="off"
       autocorrect="off"
       autocapitalize="off"
       spellcheck="false"
       name="consonant-input-random">
</h3>
    <div class="consonant-grid" id="consonantGrid">
    </div>
  </div>
<div class="game-info">
    <div class="stats" id="gameStats">
        ë§ì¶˜ ììŒ: 0ê°œ | í‹€ë¦° ììŒ: 0ê°œ
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="new-game-btn" onclick="restartGame()">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</button>
        <button class="new-game-btn" onclick="location.href='https://soosooland.com/school/index.html'">ë‹¤ë¥¸ ê³µë¶€í•˜ê¸°</button>
    </div>
</div>

<script>
const dailyThemes = {
1: { bg: '#145454', white: '#F4F6F5', black: '#1B2B2B', primary: '#91b2c7', sub: '#2F4B5C', accent: '#E8956F', name: 'ì›”ìš”ì¼' },
2: { bg: '#145454', white: '#F4F6F5', black: '#1B2B2B', primary: '#7FA89A', sub: '#355F56', accent: '#c18ff2', name: 'í™”ìš”ì¼' },
3: { bg: '#145454', white: '#F7F5F0', black: '#2A2320', primary: '#B8C46F', sub: '#6B7A3F', accent: '#f7b2e3', name: 'ìˆ˜ìš”ì¼' },
4: { bg: '#145454', white: '#F7F5F0', black: '#2A2320', primary: '#D08A5A', sub: '#A85432', accent: '#5AB8D0', name: 'ëª©ìš”ì¼' },
5: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#fcdd95', sub: '#C8A24A', accent: '#a5cbfa', name: 'ê¸ˆìš”ì¼' },
6: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#ffaaa1', sub: '#9B4A4A', accent: '#6FD0B8', name: 'í† ìš”ì¼' },
0: { bg: '#145454', white: '#F8F6FA', black: '#241F2B', primary: '#9A8FBF', sub: '#4E3F73', accent: '#C5D08F', name: 'ì¼ìš”ì¼' }
};

function applyDailyTheme() {
    const today = new Date().getDay();
    const theme = dailyThemes[today];
    const root = document.documentElement;
    root.style.setProperty('--bg-color', theme.bg);
    root.style.setProperty('--white-color', theme.white);
    root.style.setProperty('--black-color', theme.black);
    root.style.setProperty('--primary-color', theme.primary);
    root.style.setProperty('--sub-color', theme.sub);
    root.style.setProperty('--accent-color', theme.accent);
}

applyDailyTheme();

function wrapEmojis(text) {
  const emojiRegex = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
  return text.replace(emojiRegex, '<span class="emoji">$1</span>');
}

const urlParams = new URLSearchParams(window.location.search);
const wordpoolUrl = urlParams.get('wordpool');
const categoryTitle = urlParams.get('title') || 'ëª¨ìŒ ìŠ¤ì¿¨';

let sentences = [];
let originalSentences = [];
const consonants = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];

let totalQuestions = 0;
let wrongCount = 0; 
let wrongAnswers = [];
let firstAttemptWrongAnswers = [];
let guessedConsonants = new Set();
let wrongConsonants = new Set();
let gameWon = false;
let gameLost = false; 
let charStates = [];
let currentHint = '';
let currentSentence = '';
let shuffledSentences = [];
let sentenceIndex = 0;
let isFirstAttempt = true;

async function loadWordpool() {
    if (!wordpoolUrl) {
        alert('ì›Œë“œí’€ ì£¼ì†Œê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return false;
    }

    if (typeof gtag !== 'undefined') {
        gtag('event', 'game_start', {
            'game_name': 'ëª¨ìŒìŠ¤ì¿¨',
            'wordpool_file': wordpoolUrl,
            'category': categoryTitle
        });
    }

    try {
        const response = await fetch(wordpoolUrl);
        if (!response.ok) throw new Error('ì›Œë“œí’€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        sentences = await response.json();
        originalSentences = [...sentences];         
        if (!Array.isArray(sentences) || sentences.length === 0) {
            throw new Error('ì›Œë“œí’€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        return true;
    } catch (error) {
        alert('ì›Œë“œí’€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        return false;
    }
}

function shuffleSentences() {
    shuffledSentences = [...sentences];
    for (let i = shuffledSentences.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledSentences[i], shuffledSentences[j]] = [shuffledSentences[j], shuffledSentences[i]];
    }
    sentenceIndex = 0;
    totalQuestions = shuffledSentences.length;
}

function getNextSentence() {
    if (sentenceIndex >= shuffledSentences.length) return null;
    return shuffledSentences[sentenceIndex++];
}

function containsConsonant(targetChar, consonant) {
    const consonantMap = { 'ã„²': 'ã„±', 'ã„¸': 'ã„·', 'ã…ƒ': 'ã…‚', 'ã…†': 'ã……', 'ã…‰': 'ã…ˆ' };
    const complexConsonantMap = {
        'ã„³': ['ã„±', 'ã……'], 'ã„µ': ['ã„´', 'ã…ˆ'], 'ã„¶': ['ã„´', 'ã…'],
        'ã„º': ['ã„¹', 'ã„±'], 'ã„»': ['ã„¹', 'ã…'], 'ã„¼': ['ã„¹', 'ã…‚'],
        'ã„½': ['ã„¹', 'ã……'], 'ã„¾': ['ã„¹', 'ã…Œ'], 'ã„¿': ['ã„¹', 'ã…'],
        'ã…€': ['ã„¹', 'ã…'], 'ã…„': ['ã…‚', 'ã……']
    };
    if (targetChar === consonant) return true;
    if (consonantMap[targetChar] === consonant) return true;
    if (complexConsonantMap[targetChar] && complexConsonantMap[targetChar].includes(consonant)) return true;
    return false;
}

function getComplexConsonantComponents(consonant) {
    const complexConsonantMap = {
        'ã„³': ['ã„±', 'ã……'], 'ã„µ': ['ã„´', 'ã…ˆ'], 'ã„¶': ['ã„´', 'ã…'],
        'ã„º': ['ã„¹', 'ã„±'], 'ã„»': ['ã„¹', 'ã…'], 'ã„¼': ['ã„¹', 'ã…‚'],
        'ã„½': ['ã„¹', 'ã……'], 'ã„¾': ['ã„¹', 'ã…Œ'], 'ã„¿': ['ã„¹', 'ã…'],
        'ã…€': ['ã„¹', 'ã…'], 'ã…„': ['ã…‚', 'ã……']
    };
    return complexConsonantMap[consonant] || null;
}

function decomposeHangul(char) {
    const code = char.charCodeAt(0) - 0xAC00;
    if (code < 0 || code > 11171) return null;
    const jong = code % 28;
    const jung = (code - jong) / 28 % 21;
    const cho = ((code - jong) / 28 - jung) / 21;
    const choTable = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    const jungTable = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
    const jongTable = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    return {
        cho: choTable[cho],
        jung: jungTable[jung],
        jong: jong === 0 ? '' : jongTable[jong]
    };
}

function composeHangul(cho, jung, jong = '') {
    const choTable = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    const jungTable = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
    const jongTable = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    
    const choIndex = choTable.indexOf(cho);
    const jungIndex = jungTable.indexOf(jung);
    const jongIndex = jongTable.indexOf(jong);
    if (choIndex === -1 || jungIndex === -1 || jongIndex === -1) return null;
    const code = 0xAC00 + (choIndex * 21 + jungIndex) * 28 + jongIndex;
    return String.fromCharCode(code);
}

function isJongComplete(charData) {
    if (!charData.jong) return true;
    const doubleConsonantMap = { 'ã„²': 'ã„±', 'ã…†': 'ã……' };
    if (doubleConsonantMap[charData.jong]) {
        const baseConsonant = doubleConsonantMap[charData.jong];
        return charData.foundJongComponents.has(baseConsonant) || charData.foundJongComponents.has(charData.jong);
    }
    const components = getComplexConsonantComponents(charData.jong);
    if (!components) {
        return charData.foundJongComponents.has(charData.jong);
    } else {
        return components.every(comp => charData.foundJongComponents.has(comp));
    }
}

function isCharComplete(charData) {
    return charData.choFound && isJongComplete(charData);
}

function createConsonantButtons() {
    const grid = document.getElementById('consonantGrid');
    grid.innerHTML = '';
    consonants.forEach(consonant => {
        const button = document.createElement('button');
        button.className = 'consonant-btn available';
        button.textContent = consonant;
        button.onclick = () => handleConsonantClick(consonant);
        button.id = `btn-${consonant}`;
        grid.appendChild(button);
    });
    
    const input = document.getElementById('consonantInput');
    if (input) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        
        newInput.addEventListener('input', function(e) {
            const value = e.target.value;
            if (value && consonants.includes(value)) {
                handleConsonantClick(value);
                setTimeout(() => { e.target.value = ''; }, 100);
            }
        });
        
        // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
        newInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (gameWon) {
                    nextRound();
                }
            }
        });
        
        setTimeout(() => { newInput.focus(); }, 100);
    }
}

function getFoundJongDisplay(charData) {
    if (!charData.jong) return '';
    const doubleConsonantMap = { 'ã„²': 'ã„±', 'ã…†': 'ã……' };
    if (doubleConsonantMap[charData.jong]) {
        const baseConsonant = doubleConsonantMap[charData.jong];
        if (charData.foundJongComponents.has(baseConsonant) || charData.foundJongComponents.has(charData.jong)) {
            return charData.jong;
        }
        return '';
    }
    const components = getComplexConsonantComponents(charData.jong);
    if (!components) {
        return charData.foundJongComponents.has(charData.jong) ? charData.jong : '';
    } else {
        const foundParts = components.filter(comp => charData.foundJongComponents.has(comp));
        if (foundParts.length === 0) return '';
        if (foundParts.length === components.length) return charData.jong;
        else return foundParts.join('');
    }
}

function updateDisplay() {
    const words = [];
    let currentWord = [];

    charStates.forEach(charData => {
        if (charData.isSpace) {
            if (currentWord.length > 0) {
                words.push(currentWord);
                currentWord = [];
            }
        } else {
            if (charData.isNonHangul) {
                currentWord.push(`<span class="hangul-char complete-char">${charData.char}</span>`);
            } else {
                let displayCho = charData.choFound ? charData.cho : '';
                let displayJung = charData.jung;
                let displayJong = getFoundJongDisplay(charData);

                if (displayCho && displayJong) {
                    currentWord.push(`<span class="hangul-char complete-char">${composeHangul(displayCho, displayJung, displayJong)}</span>`);
                } else if (displayCho && !charData.jong) {
                    currentWord.push(`<span class="hangul-char complete-char">${composeHangul(displayCho, displayJung)}</span>`);
                } else if (displayCho) {
                    currentWord.push(`<span class="hangul-char incomplete-char">${composeHangul(displayCho, displayJung)}</span>`);
                } else if (displayJong) {
                    currentWord.push(`<span class="hangul-char incomplete-char" style="position: relative; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; min-width: 1em; height: 1.2em;"><span style="font-size: 0.8em;">${displayJung}</span><span style="font-size: 0.7em; margin-top: -0.1em;">${displayJong}</span></span>`);
                } else {
                    currentWord.push(`<span class="hangul-char incomplete-char">${displayJung}</span>`);
                }
            }
        }
    });

    if (currentWord.length > 0) words.push(currentWord);
    const wordGroups = words.map(word => `<span class="word-group">${word.join('')}</span>`);
    document.getElementById('sentenceArea').innerHTML = wordGroups.join('');
}

function handleConsonantClick(consonant) {
    if (guessedConsonants.has(consonant) || wrongConsonants.has(consonant) || gameWon || gameLost) return;

    let found = false;
    charStates.forEach(charData => {
        if (charData.isSpace || charData.isNonHangul) return;
        
        if (!charData.choFound && containsConsonant(charData.cho, consonant)) {
            charData.choFound = true;
            found = true;
        }
        
        if (charData.jong && containsConsonant(charData.jong, consonant)) {
            if (!charData.foundJongComponents.has(consonant)) {
                charData.foundJongComponents.add(consonant);
                found = true;
                if (isJongComplete(charData)) charData.jongFound = true;
            }
        }
    });

    if (found) {
        guessedConsonants.add(consonant);
        document.getElementById(`btn-${consonant}`).className = 'consonant-btn correct';
        updateDisplay();
        const allComplete = charStates.every(charData =>
            charData.isSpace || charData.isNonHangul || isCharComplete(charData)
        );

        if (allComplete) {
            gameWon = true;
            
            if (isFirstAttempt && wrongConsonants.size > 0) {
                firstAttemptWrongAnswers.push({text: currentSentence, hint: currentHint});
            }
            
            if (wrongConsonants.size > 0) {
                wrongAnswers.push({text: currentSentence, hint: currentHint});
                wrongCount++;
            }
            
            document.getElementById('winMessage').style.display = 'block';
        }

    } else { 
        wrongConsonants.add(consonant);
        document.getElementById(`btn-${consonant}`).className = 'consonant-btn wrong';
    }

    updateStats();
} 

function updateStats() {
    document.getElementById('gameStats').innerHTML =
        `ë§ì¶˜ ììŒ: ${guessedConsonants.size}ê°œ | í‹€ë¦° ììŒ: ${wrongConsonants.size}ê°œ`;
}

function saveForReview(text, hint) {
    try {
        const wordpoolName = wordpoolUrl.split('/').pop().replace('.json', '');
const now = new Date();
const today = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const reviewSchedule = {
            text: text,
            hint: hint,
            firstAttemptDate: today.toISOString().split('T')[0],
            reviews: [
                addDays(today, 3).toISOString().split('T')[0],
                addDays(today, 7).toISOString().split('T')[0],
                addDays(today, 14).toISOString().split('T')[0],
                addDays(today, 28).toISOString().split('T')[0]
            ],
            completedReviews: 0
        };
        
        const allReviews = JSON.parse(localStorage.getItem('moeumschool_reviews') || '{}');
        if (!allReviews[wordpoolName]) allReviews[wordpoolName] = [];
        
        const exists = allReviews[wordpoolName].some(item => item.text === text);
        if (!exists) {
            allReviews[wordpoolName].push(reviewSchedule);
            localStorage.setItem('moeumschool_reviews', JSON.stringify(allReviews));
        }
    } catch (error) {
        console.error('ë³µìŠµ ì¼ì • ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function startRound() {
    const randomSentenceData = getNextSentence();
    
    if (!randomSentenceData) {
        showFinalScore();
        return;
    }
    
    currentSentence = randomSentenceData.text;
    currentHint = randomSentenceData.hint;
    guessedConsonants = new Set();
    wrongConsonants = new Set();
    gameWon = false;
    gameLost = false;
    charStates = [];
    
    document.getElementById('winMessage').style.display = 'none';
    document.getElementById('loseMessage').style.display = 'none';
    document.getElementById('finalMessage').style.display = 'none';
    document.getElementById('hintText').innerHTML = wrapEmojis(currentHint);

    document.getElementById('roundDisplay').textContent = `ë¬¸ì œ ${sentenceIndex}/${totalQuestions}`;
    document.getElementById('scoreDisplay').textContent = `ì˜¤ë‹µ: ${wrongCount}ê°œ`;
   
    for (let char of currentSentence) {
        if (char === ' ') {
            charStates.push({ isSpace: true });
        } else {
            const decomposed = decomposeHangul(char);
            if (!decomposed) {
                charStates.push({ isNonHangul: true, char });
            } else {
                charStates.push({
                    char,
                    cho: decomposed.cho,
                    jung: decomposed.jung,
                    jong: decomposed.jong,
                    choFound: false,
                    jongFound: false,
                    foundJongComponents: new Set(),
                    isSpace: false,
                    isNonHangul: false
                });
            }
        }
    }

    updateDisplay();
    createConsonantButtons();
    updateStats();
}

function nextRound() {
    startRound();
    setTimeout(() => {
        const input = document.getElementById('consonantInput');
        if (input) input.focus();
    }, 200);
}

function saveProgress() {
    try {
        const wordpoolName = wordpoolUrl.split('/').pop().replace('.json', '');
        const allProgress = JSON.parse(localStorage.getItem('moeumschool_progress') || '{}');
        const progress = allProgress[wordpoolName] || { attempts: [] };

const now = new Date();
const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
const today = koreaTime.toISOString().split('T')[0];
        // ì²«íŒì—ì„œ í‹€ë¦° ë¬¸ì œê°€ 0ê°œì¼ ë•Œ = ğŸ† íŠ¸ë¡œí”¼
        if (isFirstAttempt && firstAttemptWrongAnswers.length === 0) {
            progress.attempts = [
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 },
                { date: today, accuracy: 100 }
            ];
            allProgress[wordpoolName] = progress;
            localStorage.setItem('moeumschool_progress', JSON.stringify(allProgress));
            console.log('ğŸ† ì²«íŒ 100ì ! íŠ¸ë¡œí”¼ íšë“!');
            return true;
        }
        // ì²«íŒì—ì„œ í‹€ë ¸ì§€ë§Œ, ë‹¤ì‹œ í’€ì–´ì„œ ì™„ë£Œ = 1íšŒ ì €ì¥
        else if (isFirstAttempt && firstAttemptWrongAnswers.length > 0) {
            progress.attempts.push({ date: today, accuracy: 100 });
            allProgress[wordpoolName] = progress;
            localStorage.setItem('moeumschool_progress', JSON.stringify(allProgress));
            
            // ì²«íŒì—ì„œ í‹€ë¦° ë¬¸ì œë“¤ ë³µìŠµ ì¼ì • ì €ì¥
            firstAttemptWrongAnswers.forEach(item => {
                saveForReview(item.text, item.hint);
            });
            
            console.log('1íšŒ ì™„ë£Œ! ë³µìŠµ ì¼ì • ì €ì¥ë¨');
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('ì§„ë„ ì €ì¥ ì‹¤íŒ¨:', error);
        return false;
    }
}

function showFinalScore() {
    const correct = totalQuestions - wrongCount;
    const accuracy = Math.round((correct / totalQuestions) * 100);
    
    document.getElementById('totalQuestions').textContent = totalQuestions;
    document.getElementById('correctCount').textContent = correct;
    document.getElementById('wrongCount').textContent = wrongCount;
    document.getElementById('accuracy').textContent = accuracy;
    
    document.querySelector('.game-board').style.display = 'none';
    document.getElementById('finalMessage').style.display = 'block';
    
    // âœ… í‹€ë¦° ë¬¸ì œê°€ 0ê°œì¼ ë•Œë§Œ ì§„ë„ ì €ì¥!
    let saved = false;
    if (wrongCount === 0) {
        saved = saveProgress();
    }
    
    if (wrongCount === 0 && !saved) {
        const finalAlert = document.querySelector('.final-alert');
        const practiceMsg = document.createElement('div');
        practiceMsg.style.marginTop = '15px';
        practiceMsg.style.fontSize = '1.1em';
        practiceMsg.style.color = '#FF9800';
        practiceMsg.innerHTML = 'ğŸ† ì—°ìŠµ ëª¨ë“œ - ê¸°ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
        finalAlert.appendChild(practiceMsg);
    }
    
    if (wrongCount > 0) {  
        document.getElementById('wrongCountForRetry').textContent = wrongCount;
        document.getElementById('retryWrongBtn').style.display = 'inline-block';
    } else {
        document.getElementById('retryWrongBtn').style.display = 'none';
    }
}

function retryWrongAnswers() {
    sentences = [...wrongAnswers];
    wrongAnswers = [];
    wrongCount = 0;
    
    shuffleSentences();
    document.querySelector('.game-board').style.display = 'block';
    document.getElementById('finalMessage').style.display = 'none';
    startRound();
}

function restartGame() {
    sentences = [...originalSentences];
    wrongCount = 0;
    wrongAnswers = [];
    firstAttemptWrongAnswers = [];
    isFirstAttempt = true;
    
    shuffleSentences();
    document.querySelector('.game-board').style.display = 'block';
    document.getElementById('finalMessage').style.display = 'none';
    startRound();
}

window.onload = async function () {
    const success = await loadWordpool();
    if (success) {
        document.getElementById('categoryTitle').textContent = categoryTitle;
        createConsonantButtons();
        shuffleSentences();
        restartGame();  
    }
};

</script>

</body>
</html>
